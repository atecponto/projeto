{% extends 'contratos/base_contrato.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">{{ titulo }}</h5>
        {% if form.instance.pk %}
            {% if form.instance.ativo %}
                <span class="badge bg-success">Cliente Ativo</span>
            {% else %}
                <span class="badge bg-danger">Cliente Inativo</span>
            {% endif %}
        {% endif %}
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" id="clienteForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
                <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}

            <div class="mb-3">
                <label for="{{ form.empresa.id_for_label }}" class="form-label"><strong>Empresa:</strong></label>
                {{ form.empresa }}
                {% if form.empresa.errors %}<div class="text-danger small mt-1">{{ form.empresa.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ form.cnpj.id_for_label }}" class="form-label"><strong>CNPJ:</strong></label>
                {{ form.cnpj }}
                {% if form.cnpj.errors %}<div class="text-danger small mt-1">{{ form.cnpj.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ form.sistema.id_for_label }}" class="form-label"><strong>Sistema:</strong></label>
                {{ form.sistema }}
                {% if form.sistema.errors %}<div class="text-danger small mt-1">{{ form.sistema.errors }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ form.tecnico.id_for_label }}" class="form-label"><strong>Técnico:</strong></label>
                {{ form.tecnico }}
                {% if form.tecnico.errors %}<div class="text-danger small mt-1">{{ form.tecnico.errors }}</div>{% endif %}
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="{{ form.validade.id_for_label }}" class="form-label"><strong>Validade do Contrato:</strong></label>
                    {{ form.validade }}
                    {% if form.validade.errors %}<div class="text-danger small mt-1">{{ form.validade.errors }}</div>{% endif %}
                </div>
                <div class="col-md-8">
                    <label class="form-label"><strong>Tipo de Cobrança:</strong></label>
                    <div class="btn-group btn-group-sm w-100" role="group">
                        <input type="radio" class="btn-check" name="{{ form.tipo_cobranca.name }}" id="id_tipo_mensal" value="M" autocomplete="off" {% if form.instance.tipo_cobranca == 'M' or form.tipo_cobranca.value == 'M' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="id_tipo_mensal">Mensal</label>
                        <input type="radio" class="btn-check" name="{{ form.tipo_cobranca.name }}" id="id_tipo_anual" value="A" autocomplete="off" {% if form.instance.tipo_cobranca == 'A' or form.tipo_cobranca.value == 'A' %}checked{% endif %}>
                        <label class="btn btn-outline-primary" for="id_tipo_anual">Anual</label>
                    </div>
                    {% if form.tipo_cobranca.errors %}<div class="text-danger small mt-1">{{ form.tipo_cobranca.errors }}</div>{% endif %}
                    
                    <div id="campos_mensal" style="display: {% if form.instance.tipo_cobranca == 'M' or form.tipo_cobranca.value == 'M' %}block{% else %}none{% endif %};" class="mt-2">
                        <div class="row align-items-center">
                            <div class="col"><label for="id_valor_mensal" class="form-label form-label-sm">Valor Mensal</label>{{ form.valor_mensal }}</div>
                            <div class="col-auto text-center pt-3">X</div>
                            <div class="col-3"><label for="id_meses_contrato" class="form-label form-label-sm">Meses</label>{{ form.meses_contrato }}</div>
                            <div class="col-auto text-center pt-3">=</div>
                            <div class="col"><label for="id_valor_total" class="form-label form-label-sm">Valor Total</label><input type="text" id="id_valor_total" class="form-control form-control-sm" readonly></div>
                        </div>
                        {% if form.valor_mensal.errors %}<div class="text-danger small mt-1">{{ form.valor_mensal.errors }}</div>{% endif %}
                    </div>
                    <div id="campos_anual" style="display: {% if form.instance.tipo_cobranca == 'A' or form.tipo_cobranca.value == 'A' %}block{% else %}none{% endif %};" class="mt-2">
                        <div class="row"><div class="col-lg-6 col-md-8"><label for="id_valor_anual" class="form-label form-label-sm">Valor Anual</label>{{ form.valor_anual }}{% if form.valor_anual.errors %}<div class="text-danger small mt-1">{{ form.valor_anual.errors }}</div>{% endif %}</div></div>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.descricao.id_for_label }}" class="form-label"><strong>Descrição:</strong></label>
                {{ form.descricao }}
            </div>

            <div class="mb-3">
                <label for="{{ form.pdf_anexo.id_for_label }}" class="form-label"><strong>Anexo PDF:</strong></label>
                {{ form.pdf_anexo }}
                {% if form.instance.pdf_anexo %}<small class="d-block mt-1">Arquivo atual: <a href="{{ form.instance.pdf_anexo.url }}" target="_blank">{{ form.instance.pdf_anexo.name }}</a></small>{% endif %}
            </div>

            <div class="form-check mb-3">
                {{ form.bloqueado }}
                <label class="form-check-label" for="{{ form.bloqueado.id_for_label }}">{{ form.bloqueado.label }}</label>
            </div>

            <input type="hidden" name="confirm_duplicate" id="confirm_duplicate_input" value="no">

            <div class="d-flex justify-content-between mt-4">
                <div>
                    {% if form.instance.pk %}
                        <button type="button" 
                                class="btn {% if form.instance.ativo %}btn-warning{% else %}btn-success{% endif %}"
                                data-bs-toggle="modal" 
                                data-bs-target="#confirmToggleAtivoModal">
                            {% if form.instance.ativo %}
                                <i class="fas fa-times-circle me-1"></i> Inativar
                            {% else %}
                                <i class="fas fa-check-circle me-1"></i> Ativar
                            {% endif %}
                        </button>
                    {% endif %}
                </div>
                <div>
                    <a href="{% url 'listar_clientes' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if form.instance.pk %}
<div class="modal fade" id="confirmToggleAtivoModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="confirmModalLabel">Confirmação de Ação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Tem certeza que deseja <strong>{{ form.instance.ativo|yesno:"inativar,ativar" }}</strong> este cliente?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" 
                        class="btn {% if form.instance.ativo %}btn-warning{% else %}btn-success{% endif %}"
                        form="clienteForm"
                        formaction="{% url 'toggle_ativo_cliente' form.instance.pk %}">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="modal fade" id="confirmDuplicateModal" tabindex="-1" aria-labelledby="confirmDuplicateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="confirmDuplicateModalLabel">Atenção: CNPJ Já Cadastrado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>O CNPJ <strong>{{ existing_cnpj }}</strong> já existe no sistema.</p>
                <p>Deseja fazer um novo cadastro para este CNPJ mesmo assim?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não, Cancelar</button>
                <button type="button" id="confirmDuplicateButton" class="btn btn-primary">Sim, Cadastrar Mesmo Assim</button>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- INÍCIO DO SCRIPT DE MÁSCARA CPF/CNPJ ATUALIZADO ---
        // Ele agora usa 'id_cnpj' que é o ID correto do campo
        const cnpjInput = document.getElementById('id_cnpj');
        if (cnpjInput) {
            cnpjInput.addEventListener('input', function (e) {
                let valor = e.target.value.replace(/\D/g, ''); // Remove tudo que não é dígito

                if (valor.length <= 11) { // Formatação de CPF
                    valor = valor.substring(0, 11); // Garante que não passe de 11
                    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                    valor = valor.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
                    valor = valor.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
                } else { // Formatação de CNPJ
                    valor = valor.substring(0, 14); // Garante que não passe de 14
                    // Aplica a máscara de CNPJ
                    valor = valor.replace(/^(\d{2})(\d)/, '$1.$2');
                    valor = valor.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                    valor = valor.replace(/\.(\d{3})(\d)/, '.$1/$2');
                    valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
                }
                e.target.value = valor;
            });
        }
        // --- FIM DO SCRIPT DE MÁSCARA ---
        
        
        // --- Seu script de cálculo de valor (mantido 100%) ---
        const radioMensal = document.getElementById('id_tipo_mensal');
        const radioAnual = document.getElementById('id_tipo_anual');
        const camposMensal = document.getElementById('campos_mensal');
        const camposAnual = document.getElementById('campos_anual');
        const valorMensalInput = document.getElementById('id_valor_mensal');
        const mesesContratoInput = document.getElementById('id_meses_contrato');
        const valorTotalInput = document.getElementById('id_valor_total');

        function toggleCampos() {
            if (radioMensal.checked) {
                camposMensal.style.display = 'block';
                camposAnual.style.display = 'none';
            } else if (radioAnual.checked) {
                camposMensal.style.display = 'none';
                camposAnual.style.display = 'block';
            } else {
                camposMensal.style.display = 'none';
                camposAnual.style.display = 'none';
            }
        }

        function calcularTotal() {
            if (!valorMensalInput) return; // Verificação de segurança
            let valorString = valorMensalInput.value;
            if (!valorString) {
                valorTotalInput.value = (0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                return;
            }
            if (valorString.includes(',')) {
                valorString = valorString.replace(/\./g, '').replace(',', '.');
            }
            const valorMensal = parseFloat(valorString) || 0;
            const meses = parseInt(mesesContratoInput.value) || 0;
            const total = valorMensal * meses;
            valorTotalInput.value = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        if(radioMensal && radioAnual) { // Verificação de segurança
            radioMensal.addEventListener('change', toggleCampos);
            radioAnual.addEventListener('change', toggleCampos);
        }
        
        if (valorMensalInput && mesesContratoInput) { // Verificação de segurança
            valorMensalInput.addEventListener('input', calcularTotal);
            mesesContratoInput.addEventListener('input', calcularTotal);
        }

        toggleCampos();
        if(valorMensalInput && valorMensalInput.value) { 
            calcularTotal();
        }
        // --- Fim do seu script de cobrança ---


        // --- SCRIPT PARA MOSTRAR O MODAL (mantido 100%) ---
        const showConfirmation = {{ show_confirmation|yesno:"true,false" }};
        const confirmDuplicateModalElement = document.getElementById('confirmDuplicateModal');
        const confirmDuplicateButton = document.getElementById('confirmDuplicateButton');
        const clienteForm = document.getElementById('clienteForm');
        const confirmDuplicateInput = document.getElementById('confirm_duplicate_input');

        if (showConfirmation && confirmDuplicateModalElement) {
            const modal = new bootstrap.Modal(confirmDuplicateModalElement);
            modal.show();
        }

        if (confirmDuplicateButton && clienteForm && confirmDuplicateInput) {
            confirmDuplicateButton.addEventListener('click', function() {
                confirmDuplicateInput.value = 'yes';
                clienteForm.submit();
            });
        }
        // --- FIM DO NOVO SCRIPT ---
    });
</script>

{% endblock %}