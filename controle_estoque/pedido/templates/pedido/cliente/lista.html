{% extends "pedido/base_pedido.html" %}
{% load static %} {% load i18n %} {% block title %}Lista de Pedidos{% endblock %}

{% block extra_css %}
<style>
    .table-container-sticky {
        max-height: 65vh; 
        overflow-y: auto;
        position: relative;
    }
    .table-container-sticky thead th {
        position: -webkit-sticky; /* Safari */
        position: sticky;
        top: 0; 
        z-index: 2;
        background-color: #ffffff; 
        border-bottom-width: 2px;
    }
    
    /* --- INÍCIO DO NOVO CSS DE IMPRESSÃO (CORRIGIDO) --- */
    @media print {
        /* Esconde a barra lateral e a navbar superior */
        #sidebar-wrapper, #page-content-wrapper > .navbar {
            display: none;
        }
        
        /* Esconde o conteúdo principal (o card da lista) */
        #page-content-wrapper > .container-fluid > .card {
            display: none;
        }
        
        /* Esconde o backdrop (fundo cinza) do modal */
        .modal-backdrop {
            display: none !important;
        }

        /* Faz o modal ativo preencher a tela de impressão */
        .modal {
            position: relative !important; 
            display: block !important; /* Força a exibição do modal que está ativo */
            opacity: 1 !important;
            width: 100%;
            height: 100%;
            overflow: visible !important; /* Remove scrollbars internos */
        }
        
        /* Garante que apenas o modal que está aberto (classe .show) seja impresso */
        .modal:not(.show) {
             display: none !important;
        }

        .modal-dialog {
            max-width: 100% !important;
            width: 100% !important;
            margin: 0 !important;
            transform: none !important; /* Reseta qualquer transformação */
        }
        
        .modal-content {
            border: none !important;
            box-shadow: none !important;
        }
        
        /* Esconde os botões de fechar e do rodapé */
        .modal-header .btn-close,
        .modal-footer {
            display: none;
        }
        
        .modal-body {
            overflow: visible !important;
        }
        
        /* Remove a rolagem da página que a imagem antiga mostrava */
        html, body {
            overflow: visible !important;
            height: auto !important;
        }

        /* FORÇA O LAYOUT DE COLUNAS DO BOOTSTRAP A FUNCIONAR NA IMPRESSÃO */
        .modal-body .row {
            display: flex !important;
            flex-wrap: wrap !important;
        }
        .modal-body .col-md-6 {
            flex: 0 0 50% !important;
            max-width: 50% !important;
        }
        .modal-body .col-auto {
            flex: 0 0 auto !important;
            width: auto !important;
        }
         .modal-body .col-7 {
            flex: 0 0 auto !important; /* Ajuste para a linha de assinatura */
            width: 58.333333% !important;
        }
    }
    /* --- FIM DO NOVO CSS DE IMPRESSÃO --- */
    
    .financial-summary-wrapper {
        font-size: 0.9rem;
        color: #333;
    }
    .financial-summary-wrapper .badge {
        margin-right: 8px;
        padding: .3em .6em;
        font-weight: 500;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">Lista de Pedidos</h5>
        <a href="{% url 'pedido:criar_cliente_pedido' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Novo Pedido
        </a>
    </div>
    <div class="card-body">
        
        <form method="get" class="row g-3 mb-4 p-3 border rounded bg-light align-items-end">
            
            <div class="col-md-4">
                <label for="buscaCnpjPedido" class="form-label">Buscar por CNPJ/CPF (ao vivo)</label>
                <input type="text" id="buscaCnpjPedido" class="form-control" placeholder="Digite para buscar...">
            </div>
            
            {% if user.is_superuser %}
                <div class="col-md-4">
                    <label for="{{ filter_form.tecnico.id_for_label }}" class="form-label">{{ filter_form.tecnico.label }}</label>
                    {{ filter_form.tecnico }}
                </div>
                <div class="col-md-4">
                    <label for="{{ filter_form.categoria.id_for_label }}" class="form-label">{{ filter_form.categoria.label }}</label>
                    {{ filter_form.categoria }}
                </div>
            {% else %}
                <div class="col-md-8">
                    <label for="{{ filter_form.categoria.id_for_label }}" class="form-label">{{ filter_form.categoria.label }}</label>
                    {{ filter_form.categoria }}
                </div>
            {% endif %}

            <div class="col-md-5">
                <label class="form-label d-block">Período de Cadastro</label> 
                <div class="row g-2 align-items-center">
                    <div class="col-auto">
                        <div class="form-check">
                            {{ filter_form.filtrar_por_data }}
                            <label for="{{ filter_form.filtrar_por_data.id_for_label }}" class="form-check-label">{{ filter_form.filtrar_por_data.label }}</label>
                        </div>
                    </div>
                    <div class="col">
                        {{ filter_form.data_inicio }}
                    </div>
                    <div class="col">
                        {{ filter_form.data_fim }}
                    </div>
                </div>
            </div>

            <div class="col-md-3 ms-md-auto">
                <label class="form-label d-block">&nbsp;</label> 
                <div class="d-flex">
                    <button type="submit" class="btn btn-primary w-100 me-2">Filtrar</button>
                    <a href="{% url 'pedido:gerar_pdf_pedidos' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-secondary" 
                       title="Gerar PDF" 
                       target="_blank"
                       style="width: 50px;">
                         <i class="fas fa-file-pdf"></i>
                    </a>
                    <a href="{% url 'pedido:gerar_excel_pedidos' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-success ms-1" title="Gerar Excel" 
                       target="_blank"
                       style="width: 50px;">
                         <i class="fas fa-file-excel"></i>
                    </a>
                </div>
            </div>
            {% if filter_form.non_field_errors %}
                <div class="col-12">
                    <div class="text-danger small mt-1">{{ filter_form.non_field_errors|first }}</div>
                </div>
            {% endif %}
            
        </form>
        
        <div class="row mb-3 align-items-center financial-summary-wrapper">
            <div class="col-md-4">
                <h6 class="mb-0">
                    {{ total_clientes_encontrados }} cliente(s) encontrado(s).
                </h6>
            </div>
            
            <div class="col-md-8 text-md-end">
                {% for item in financial_summary %}
                    <span class="badge bg-light text-dark border">
                        {{ item.categoria__nome }}: <strong>R$ {{ item.total_valor|floatformat:2|default:"0,00" }}</strong>
                    </span>
                {% endfor %}
            </div>
        </div>
        
        <div class="table-responsive table-container-sticky">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nome / Empresa</th>
                        <th>CNPJ / CPF</th>
                        <th>Data de Cadastro</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        {% if user.is_superuser %}
                        <th>Técnico</th> 
                        {% endif %}
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaClientesPedido">
                    {% for cliente in page_obj %}
                    <tr>
                        <td>{{ cliente.nome }}</td>
                        <td class="cnpj-col-pedido">{{ cliente.cnpj }}</td>
                        <td>{{ cliente.data_criacao|date:"d/m/Y" }}</td>
                        <td>{{ cliente.categoria.nome|default:"-" }}</td>
                        <td>R$ {{ cliente.valor_pedido|floatformat:2|default:"0,00" }}</td>
                        
                        {% if user.is_superuser %}
                        <td>{{ cliente.tecnico.nome|default:"-" }}</td> 
                        {% endif %}
                        
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalClientePedido{{ cliente.pk }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{% url 'pedido:editar_cliente_pedido' cliente.pk %}" class="btn btn-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'pedido:excluir_cliente_pedido' cliente.pk %}" class="btn btn-danger">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td {% if user.is_superuser %}colspan="7"{% else %}colspan="6"{% endif %} class="text-center">Nenhum pedido encontrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% include 'partials/pagination.html' %}
    </div>
</div>

{% for cliente in page_obj %}
<div class="modal fade" id="modalClientePedido{{ cliente.pk }}" tabindex="-1" aria-labelledby="modalClienteLabel{{ cliente.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content"> 
            <div class="modal-header">
                <h5 class="modal-title" id="modalClienteLabel{{ cliente.pk }}">Ficha Cadastral: {{ cliente.nome }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body printable-modal">
                
                <div class="mb-3">
                    <small class="text-muted d-block">Nome/Empresa:</small>
                    <h5>{{ cliente.nome|default:"N/A" }}</h5>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">CNPJ/CPF:</small>
                        <span class="cnpj-col-pedido">{{ cliente.cnpj|default:"N/A" }}</span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Data de Cadastro:</small>
                        {{ cliente.data_criacao|date:"d/m/Y H:i" }}
                    </div>
                </div>
                <hr>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Email:</small>
                        {{ cliente.email|default:"Não informado" }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Pessoa de Contato:</small>
                        {{ cliente.contato|default:"Não informado" }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Telefone:</small>
                        <span class="telefone-col-pedido">{{ cliente.telefone|default:"Não informado" }}</span>
                    </div>
                </div>
                <hr>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Endereço:</small>
                        {{ cliente.endereco|default:"Não informado" }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Cidade:</small>
                        {{ cliente.cidade|default:"Não informada" }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">CEP:</small>
                        <span class="cep-col-pedido">{{ cliente.cep|default:"Não informado" }}</span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Estado (UF):</small>
                        {{ cliente.estado|default:"Não informado" }}
                    </div>
                </div>
                <hr>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Categoria:</small>
                        {{ cliente.categoria.nome|default:"N/A" }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Descrição:</small>
                        {{ cliente.descricao_pedido|default:"Nenhuma"|linebreaksbr }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Técnico Responsável:</small>
                        {{ cliente.tecnico.nome|default:"N/A" }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <small class="text-muted d-block">Valor do Pedido:</small>
                        <strong class="fs-6">R$ {{ cliente.valor_pedido|floatformat:2|default:"0,00" }}</strong>
                    </div>
                </div>

                <hr class="my-4">
                <div class="row align-items-end" style="margin-top: 40px;">
                    <div class="col-auto">
                        <p class="mb-0"><strong>Assinatura:</strong></p>
                    </div>
                    <div class="col-7">
                        <p style="border-bottom: 1px solid #333; height: 1rem;"></p>
                    </div>
                </div>
                
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-print-modal">
                    <i class="fas fa-print me-1"></i> Imprimir
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (Scripts de busca e formatação - todos existentes) ...
    const buscaInput = document.getElementById('buscaCnpjPedido');
    const tabelaBody = document.getElementById('tabelaClientesPedido');
    const linhasTabela = tabelaBody.getElementsByTagName('tr');
    if (buscaInput) {
        buscaInput.addEventListener('keyup', function() {
            const termoBusca = this.value.replace(/[\.\-\/]/g, '').toUpperCase();
            for (let i = 0; i < linhasTabela.length; i++) {
                const linha = linhasTabela[i];
                const celulaCnpj = linha.querySelector('.cnpj-col-pedido');
                if (celulaCnpj) {
                    const textoCelula = celulaCnpj.textContent || celulaCnpj.innerText;
                    const textoCelulaLimpo = textoCelula.replace(/[\.\-\/]/g, '').toUpperCase();
                    if (textoCelulaLimpo.includes(termoBusca)) {
                        linha.style.display = '';
                    } else {
                        linha.style.display = 'none';
                    }
                }
            }
        });
    }
    function formatarDocumento(celula) {
        let valor = celula.textContent.replace(/\D/g, ''); 
        if (valor.length === 11) {
            valor = valor.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            celula.textContent = valor;
        } else if (valor.length === 14) {
            valor = valor.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            celula.textContent = valor;
        }
    }
    document.querySelectorAll('.cnpj-col-pedido').forEach(formatarDocumento);
    function formatarTelefone(celula) {
        let valor = celula.textContent.replace(/\D/g, '');
        if (valor.length === 11) {
            valor = valor.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            celula.textContent = valor;
        } else if (valor.length === 10) {
            valor = valor.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            celula.textContent = valor;
        }
    }
    document.querySelectorAll('.telefone-col-pedido').forEach(formatarTelefone);
    function formatarCEP(celula) {
         let valor = celula.textContent.replace(/\D/g, '');
         if (valor.length === 8) {
             valor = valor.replace(/(\d{5})(\d{3})/, '$1-$2');
             celula.textContent = valor;
         }
    }
    document.querySelectorAll('.cep-col-pedido').forEach(formatarCEP);
    
    // --- SCRIPT DE IMPRESSÃO ATUALIZADO ---
    document.querySelectorAll('.btn-print-modal').forEach(function(button) {
        button.addEventListener('click', function() {
            // Agora, o 'printable-modal' é o 'modal-body'
            const modalBodyToPrint = this.closest('.modal-content').querySelector('.printable-modal');
            
            // Adiciona/Remove a classe 'printable-modal-active' no 'modal-body'
            modalBodyToPrint.classList.add('printable-modal-active');
            
            window.addEventListener('afterprint', function() {
                modalBodyToPrint.classList.remove('printable-modal-active');
            }, { once: true }); 
            
            window.print();
        });
    });
    
});
</script>
{% endblock %}