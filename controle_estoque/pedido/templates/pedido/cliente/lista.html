{% extends "pedido/base_pedido.html" %}
{% load static %} {% load i18n %} {% block title %}Lista de Pedidos{% endblock %}

{% block extra_css %}
<style>
    .table-container-sticky {
        max-height: 65vh; 
        overflow-y: auto;
        position: relative;
    }
    .table-container-sticky thead th {
        position: -webkit-sticky; /* Safari */
        position: sticky;
        top: 0; 
        z-index: 2;
        background-color: #ffffff; 
        border-bottom-width: 2px;
    }
    @media print {
        body * { visibility: hidden; }
        .printable-modal, .printable-modal * { visibility: visible; }
        .printable-modal { position: absolute; left: 0; top: 0; width: 100%; border: none; box-shadow: none; }
        .printable-modal .modal-dialog { max-width: 100% !important; width: 100% !important; margin: 0 !important; }
        .printable-modal .modal-content { border: none; box-shadow: none; }
        .printable-modal .modal-header .btn-close,
        .printable-modal .modal-footer { display: none; }
    }
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="m-0">Lista de Pedidos</h5>
        <a href="{% url 'pedido:criar_cliente_pedido' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Novo Pedido
        </a>
    </div>
    <div class="card-body">
        
        <form method="get" class="row g-3 mb-4 p-3 border rounded bg-light align-items-end">
            
            <div class="col-md-4">
                <label for="buscaCnpjPedido" class="form-label">Buscar por CNPJ</label>
                <input type="text" id="buscaCnpjPedido" class="form-control" placeholder="Digite para buscar...">
            </div>

            <div class="col-md-5">
                <label class="form-label d-block"></label> 
                
                <div class="row g-2 align-items-center">
                    
                    <div class="col-auto pe-0"> <div class="form-check">
                            {{ filter_form.filtrar_por_data }}
                            <label for="{{ filter_form.filtrar_por_data.id_for_label }}" class="form-check-label">{{ filter_form.filtrar_por_data.label }}</label>
                        </div>
                    </div>

                    <div class="col"> {{ filter_form.data_inicio }}
                    </div>
                    
                    <div class="col"> {{ filter_form.data_fim }}
                    </div>
                </div>
                {% if filter_form.data_inicio.errors or filter_form.data_fim.errors or filter_form.non_field_errors %}
                    <div class_name="text-danger small mt-1">
                        {% if filter_form.non_field_errors %}
                            {{ filter_form.non_field_errors|first }}
                        {% else %}
                            {{ filter_form.data_inicio.errors|first }} {{ filter_form.data_fim.errors|first }}
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <div class="col-md-2">
                <label for="{{ filter_form.categoria.id_for_label }}" class="form-label">{{ filter_form.categoria.label }}</label>
                {{ filter_form.categoria }}
            </div>

            <div class="col-md-1">
                <label class="form-label d-block">&nbsp;</label> <button type="submit" class="btn btn-outline-primary w-100">Filtrar</button>
            </div>
            
        </form>
        <div class="table-responsive table-container-sticky">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nome / Empresa</th>
                        <th>CNPJ</th>
                        <th>Data de Cadastro</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaClientesPedido">
                    {% for cliente in page_obj %}
                    <tr>
                        <td>{{ cliente.nome }}</td>
                        <td class="cnpj-col-pedido">{{ cliente.cnpj }}</td>
                        <td>{{ cliente.data_criacao|date:"d/m/Y" }}</td>
                        <td>{{ cliente.categoria.nome|default:"-" }}</td>
                        <td>R$ {{ cliente.valor_pedido|floatformat:2|default:"0,00" }}</td>
                        
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalClientePedido{{ cliente.pk }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <a href="{% url 'pedido:editar_cliente_pedido' cliente.pk %}" class="btn btn-warning">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'pedido:excluir_cliente_pedido' cliente.pk %}" class="btn btn-danger">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">Nenhum pedido encontrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% include 'partials/pagination.html' %}
    </div>
</div>

{% for cliente in page_obj %}
<div class="modal fade" id="modalClientePedido{{ cliente.pk }}" tabindex="-1" aria-labelledby="modalClienteLabel{{ cliente.pk }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content printable-modal"> 
            <div class="modal-header">
                <h5 class="modal-title" id="modalClienteLabel{{ cliente.pk }}">Ficha Cadastral: {{ cliente.nome }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Detalhes do Pedido</h6>
                <dl class="row">
                    <dt class="col-sm-3">Nome/Empresa</dt><dd class="col-sm-9">{{ cliente.nome }}</dd>
                    <dt class="col-sm-3">CNPJ/CPF</dt><dd class="col-sm-9 cnpj-col-pedido">{{ cliente.cnpj }}</dd>
                    <dt class="col-sm-3">Data de Cadastro</dt><dd class="col-sm-9">{{ cliente.data_criacao|date:"d/m/Y H:i" }}</dd>
                    <dt class="col-sm-3">Cadastrado por</dt><dd class="col-sm-9">{{ cliente.usuario_criador.username|default:"N/A" }}</dd>
                </dl>
                <hr>
                <h6>Contato</h6>
                <dl class="row">
                    <dt class="col-sm-3">Email</dt><dd class="col-sm-9">{{ cliente.email|default:"Não informado" }}</dd>
                    <dt class="col-sm-3">Telefone</dt><dd class="col-sm-9 telefone-col-pedido">{{ cliente.telefone|default:"Não informado" }}</dd>
                    <dt class="col-sm-3">Pessoa de Contato</dt><dd class="col-sm-9">{{ cliente.contato|default:"Não informado" }}</dd>
                </dl>
                <hr>
                <h6>Endereço</h6>
                <dl class="row">
                    <dt class="col-sm-3">Endereço</dt><dd class="col-sm-9">{{ cliente.endereco|default:"Não informado" }}</dd>
                    <dt class="col-sm-3">CEP</dt><dd class="col-sm-9 cep-col-pedido">{{ cliente.cep|default:"Não informado" }}</dd>
                    <dt class="col-sm-3">Cidade</dt><dd class="col-sm-9">{{ cliente.cidade|default:"Não informada" }}</dd>
                    <dt class="col-sm-3">Estado (UF)</dt><dd class="col-sm-9">{{ cliente.estado|default:"Não informado" }}</D>
                </dl>
                <hr>
                <h6>Detalhes de Classificação e Valor</h6>
                <dl class="row">
                    <dt class="col-sm-3">Categoria</dt><dd class="col-sm-9">{{ cliente.categoria.nome|default:"N/A" }}</dd>
                    <dt class="col-sm-3">Técnico Responsável</dt><dd class="col-sm-9">{{ cliente.tecnico.nome|default:"N/A" }}</dd>
                    <dt class="col-sm-3">Descrição</dt><dd class="col-sm-9">{{ cliente.descricao_pedido|default:"Nenhuma"|linebreaksbr }}</dd>
                    <dt class="col-sm-3">Valor do Pedido</dt><dd class="col-sm-9 fw-bold">R$ {{ cliente.valor_pedido|floatformat:2|default:"0,00" }}</dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-print-modal">
                    <i class="fas fa-print me-1"></i> Imprimir
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (Scripts de busca, formatação e impressão) ...
    const buscaInput = document.getElementById('buscaCnpjPedido');
    const tabelaBody = document.getElementById('tabelaClientesPedido');
    const linhasTabela = tabelaBody.getElementsByTagName('tr');
    if (buscaInput) {
        buscaInput.addEventListener('keyup', function() {
            const termoBusca = this.value.replace(/[\.\-\/]/g, '').toUpperCase();
            for (let i = 0; i < linhasTabela.length; i++) {
                const linha = linhasTabela[i];
                const celulaCnpj = linha.querySelector('.cnpj-col-pedido');
                if (celulaCnpj) {
                    const textoCelula = celulaCnpj.textContent || celulaCnpj.innerText;
                    const textoCelulaLimpo = textoCelula.replace(/[\.\-\/]/g, '').toUpperCase();
                    if (textoCelulaLimpo.includes(termoBusca)) {
                        linha.style.display = '';
                    } else {
                        linha.style.display = 'none';
                    }
                }
            }
        });
    }
    function formatarDocumento(celula) {
        let valor = celula.textContent.replace(/\D/g, ''); 
        if (valor.length === 11) {
            valor = valor.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            celula.textContent = valor;
        } else if (valor.length === 14) {
            valor = valor.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            celula.textContent = valor;
        }
    }
    document.querySelectorAll('.cnpj-col-pedido').forEach(formatarDocumento);
    function formatarTelefone(celula) {
        let valor = celula.textContent.replace(/\D/g, '');
        if (valor.length === 11) {
            valor = valor.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            celula.textContent = valor;
        } else if (valor.length === 10) {
            valor = valor.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            celula.textContent = valor;
        }
    }
    document.querySelectorAll('.telefone-col-pedido').forEach(formatarTelefone);
    function formatarCEP(celula) {
         let valor = celula.textContent.replace(/\D/g, '');
         if (valor.length === 8) {
             valor = valor.replace(/(\d{5})(\d{3})/, '$1-$2');
             celula.textContent = valor;
         }
    }
    document.querySelectorAll('.cep-col-pedido').forEach(formatarCEP);
    document.querySelectorAll('.btn-print-modal').forEach(function(button) {
        button.addEventListener('click', function() {
            const modalContent = this.closest('.modal-content');
            modalContent.classList.add('printable-modal-active');
            window.addEventListener('afterprint', function() {
                modalContent.classList.remove('printable-modal-active');
            }, { once: true }); 
            window.print();
        });
    });
    const modals = document.querySelectorAll('.modal.fade');
    modals.forEach(function(modal) {
        modal.addEventListener('show.bs.modal', function () {
             document.querySelectorAll('.printable-modal').forEach(function(pm) {
                 pm.classList.remove('printable-modal');
             });
             this.querySelector('.modal-content').classList.add('printable-modal');
        });
        modal.addEventListener('hidden.bs.modal', function () {
             this.querySelector('.modal-content').classList.remove('printable-modal');
        });
    });
});
</script>
{% endblock %}